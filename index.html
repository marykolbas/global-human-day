<html>
  <head>
    <title>INFO 4310 - HW 2</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap">

    <style>
        /* ------- headers ------- */
        body, button {
          font-family: 'Lato', sans-serif;
        }

        h1 {
          font-weight: normal;
          font-size: 1.65em;
        }

        h2 {
          font-weight: normal;
          font-style: italic;
          font-size: 1.25em;
        }

        h3 {
          font-size: 1.5em;
          margin-top: 0;
        }

        #subtitle-filter {
          text-decoration: underline;
          text-decoration-color:rgb(196, 196, 196);
        }

        /* ------- category filter sidebar ------- */
        #controls-sidebar {
          width: 25%;
          display: flex;
          justify-content: center;
          padding-right: 2em;
        }

        #category-filters {
            display: flex;
            flex-direction: column;
            width: 100%;
            justify-content: center;
            height: 100%;
            gap: 0.5em;
        }

        .category-filter {
          background-color: white;
          flex-grow: 1;
          border: solid 3px rgb(205, 205, 205);
          border-radius: 20px;
          font-weight: normal;
          font-size: 1em;
        }

        .category-filter:not(.active-filter):hover {
          background-color: rgb(244, 244, 244);
          cursor: pointer;
        }

        .active-filter {
          font-weight: bold;
          background-color: rgb(223, 223, 223);
          border-color: rgb(126, 126, 126);
        }

        /* ------- main scatterplot visualization ------- */
        main {
            display: flex;
        }

        #scatterplot-container {
          display: flex;
          flex-direction: column;
          width: 700px;
        }

        .gridlines line {
          stroke: #ebebeb;
        }

        .gridlines .domain {
          stroke: none;
        }

        #scatterplot circle:hover {
          cursor: pointer;
        }

        .label {
          font-size: 20px;
        }

        .axis {
          font-size: 15px;
        }

        .axis path {
          stroke: #747474;
        }

        .legend-element {
          width: 233px;
          height: 30px;
        }

        #scatterplot-legend {
          padding-bottom: 1em;
        }

        /* ------- detail sidebar ------- */
        #detail-sidebar {
          width: 25%;
          border-left: solid thin rgb(178, 178, 178);
          margin-left: 1em;
          padding-left: 1em;
        }

        line.dashed {
          stroke: #aaa;
          stroke-width: 1px;
          stroke-dasharray: 2;
        }

    </style>
  </head>

  <body>
    <div id="headers">
      <h1>The Global Human Day</h1>
      <h2>How many hours a day do people across the world spend on <span id="subtitle-filter">...</span>?</h2>
    </div>
  
    <main>
      <aside id="controls-sidebar" height="700">
        <div id="category-filters"></div>
      </aside> 
      <div id="scatterplot-container">
        <div id="scatterplot-legend" width="700" height="100"></div>
        <svg id="scatterplot" width="700" height="700"></svg>
      </div>
      <aside id="detail-sidebar" height="700">
        <!-- <svg id="bubbleplot-region" height="200" width="300" style="background: #fff; margin-top:50px" ></svg>
        <svg id="bubbleplot-country" height="200" width="300" style="background: #fff; margin-top:50px" ></svg> -->

      </aside>
    </main>
  </body>

  <script>
    // ------------------------- MAIN SCATTERPLOT SETUP -------------------------
    const scatter = d3.select("svg#scatterplot");
    const width = scatter.attr("width");
    const height = scatter.attr("height");
    const margin = {top: 25, right: 25, bottom: 60, left: 60};
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    let annotations = scatter.append("g").attr("id","annotations")
    let chartArea = scatter.append("g").attr("id","dots")
                    .attr("transform","translate("+margin.left+","+margin.top+")")
    
    const regionScale = d3.scaleOrdinal(d3.schemeCategory10);

    // ------------------------- REQUEST DATA FUNCTION -------------------------
    const requestData = async function() {
      const countries = await d3.csv("df_bycat.csv", d3.autoType);

      // populating category filter buttons with unique categories from the data
      const categoryList = [...new Set(countries.map(country => country.Category))];
      categoryList.forEach((category) => {
        document.getElementById("category-filters").innerHTML += `<button class="category-filter">${category}</button>`
      });

      // populating legend
      const regionList = [...new Set(countries.map(country => country.region_name))];
      console.log(regionList);
      regionList.forEach((region, i) => {
        document.getElementById("scatterplot-legend").innerHTML += `<svg class="legend-element">
          <circle cx=12 cy="50%"" r=6 opacity=0.8 fill=${regionScale(region)} class="legend-point">
          </circle>
          <text x="15%" y="50%" dominant-baseline="middle" class="legend-text">
            ${region}
          <text>
        </svg>`
        // d3.select("#scatterplot-legend").append("circle")
        //   .attr("cx", 50 + i*100)
        //   .attr("cy", 50)
        //   .attr("r", 6)
        //   .attr("opacity", 0.8)
        //   .attr("fill", regionScale(region));
        // d3.select("#scatterplot-legend").append("text")
        //   .attr("x", 50 + i*100)
        //   .attr("y", 80)
        //   .attr("text-anchor", "middle")
        //   .text(region);
      })

      // SETTING DEFAULT VIEW: initializing filtered subset to first category in the data
      let filteredData = countries.filter((country) => country.Category == categoryList[0]);
      d3.select(".category-filter").classed("active-filter", true);
      document.getElementById("subtitle-filter").innerHTML = formatFilterText(categoryList[0]);
      refreshScatter(filteredData);

      // ------------------------- FILTER SELECT EVENT LISTENER FUNCTION ------------------------- 
      d3.selectAll(".category-filter").on("click", function(){
        filteredData = countries.filter((country) => country.Category == d3.select(this).text());
        document.getElementById("subtitle-filter").innerHTML = formatFilterText( d3.select(this).text());

        refreshScatter(filteredData); //reset/refresh the scatterplot 
        
        d3.selectAll(".category-filter").classed("active-filter", false); // update appearance of filters
        d3.select(this).classed("active-filter", true);
      });
    }

    // ------------------------- SCATTERPLOT REFRESH FUNCTION -------------------------
    async function refreshScatter(data) {
      d3.select("#scatterplot").selectAll(".axis,.gridlines,text").remove();

        // set scatterplot scales based on what filter we're on
      const gdpExtent = d3.extent(data, d => d['GDP_percapita']); 
      const gdpScale = d3.scaleLinear().domain(gdpExtent).range([0, chartWidth]);

      let hourExtent = d3.extent(data, d => d['hoursPerDayCombined']);
      let hourScale = d3.scaleLinear().domain(hourExtent).range([chartHeight, 0]);

      let leftAxis = d3.axisLeft(hourScale)
                      .tickFormat(d3.format(""));
      let leftGridlines = d3.axisLeft(hourScale)
                            .tickSize(-chartWidth-10)
                            .tickFormat("")
      let bottomAxis = d3.axisBottom(gdpScale)
                        .tickFormat(d3.format("$.2s"));
      let bottomGridlines = d3.axisBottom(gdpScale)
                              .tickSize(-chartHeight-10)
                              .tickFormat("")

      //font size source: http://www.d3noob.org/2016/08/changing-text-size-for-axes-in-d3js-v4.html
      annotations.append("g")
                  .attr("class", "y axis")
                  .attr("transform",`translate(${margin.left-10},${margin.top})`)
                  .call(leftAxis)
      annotations.append("g")
                  .attr("class", "y gridlines")
                  .attr("transform",`translate(${margin.left-10},${margin.top})`)
                  .call(leftGridlines);
      annotations.append("g")
                  .attr("class", "x axis")
                  .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
                  .call(bottomAxis);
      annotations.append("g")
                  .attr("class", "x gridlines")
                  .attr("transform",`translate(${margin.left},${chartHeight+margin.top+10})`)
                  .call(bottomGridlines);

      scatter.append("text")
            .attr("class", "x label")
            .attr("x", chartWidth/2)
            .attr("y", chartHeight+margin.bottom+15) //hardcoded values....
            .text("GDP per capita");

      scatter.append("text")
            .attr("class", "y label")
            .attr("y", 15) //sorta hardcoded...
            .attr("x", -chartHeight/2)
            .attr("transform", "rotate(-90)")
            .text("Hours");   

      //small label for the country name on hover
      scatter.append("text")
              .attr("id", "small-label")
              .attr("x", chartWidth+50) //no idea why this has to be +50
              .attr("y", 10)
              .style("text-anchor", "end")
              .style("alignment-baseline", "hanging")
              .text("");

      let circles = chartArea.selectAll("circle.point").data(data)
                          .join(enter => enter.append("circle")
                                              .attr("class","point")
                                              .attr("opacity", 0.6)
                                            )
                          .attr("cx", d => gdpScale(d['GDP_percapita']))
                          .attr("cy", d => hourScale(d['hoursPerDayCombined']))
                          .attr("r", 6)
                          .style("opacity", 0.8)
                          .attr("fill", d => regionScale(d['region_name']))
                          .attr("country_name", d => d["country_name"])
                          .attr("selected", false);
      
      // ------------------------- CIRCLE HOVER EVENT LISTENER FUNCTION ------------------------- 
      circles.on("mouseover", function(event, d) { 
        d3.select(this)
          .transition().duration(100)
          .attr("stroke","black")
          .attr("stroke-width", 4);

        d3.select("#small-label").text(d['country_name']);
        
        console.log(d)
          //in here we could update a panel later
       
      });

      circles.on("mouseout", function(event, d) {
        d3.select(this)
          .transition().duration(100)
          .attr("stroke",d=>(d3.select(this).attr("selected")=="true" ? 'black' : ''))
          .attr("stroke-width", d=>(d3.select(this).attr("selected")=="true") ? 4 : 1);

          d3.select("#small-label").text(""); //clear the small label
      });

      // ------------------------- CIRCLE CLICK EVENT LISTENER FUNCTION -------------------------
      circles.on("click", function(event, d) {
        //my attempt to remember which circle is selected via click
        //clear all selections
        d3.selectAll("circle.point")
          .transition().duration(100)
          .attr("stroke","")
          .attr("stroke-width", 1)
          .attr("selected", false);
        //make this one selected!
        d3.select(this)
          .transition().duration(100)
          .attr("stroke","black")
          .attr("stroke-width", 4)
          .attr("selected", true);

        // ------------------------- POPULATE DETAIL TEXT -------------------------
        let detailContainer = document.getElementById("detail-sidebar");
        detailContainer.innerHTML = `<h3>${d.country_name}</h3>`
        detailContainer.innerHTML += `<p>Hours per day spent on ${formatFilterText(d.Category)}: ${d3.format(".2f")(d.hoursPerDayCombined)}</p>`
        detailContainer.innerHTML += `<p>Region: ${d.region_name}</p>`
        detailContainer.innerHTML += `<p>GDP per capita: ${d3.format("$,.2f")(d.GDP_percapita)}</p>`
        detailContainer.innerHTML += `<p>Population: ${d3.format(",")(d.population)}</p>`
        detailContainer.innerHTML += `<svg id="bubbleplot-region" height="150" width="320" ></svg>`
        detailContainer.innerHTML += `<svg id="bubbleplot-all" height="150" width="320"></svg>`

        // ------------------------- DETAIL VISUALIZATIONS SETUP -------------------------
        // setup for the side panel visualizations
        const bp_region = d3.select("svg#bubbleplot-region");
        const region_width = bp_region.attr("width");
        const region_height = bp_region.attr("height");
        const bp_all = d3.select("svg#bubbleplot-all");
        const all_width = bp_all.attr("width");
        const all_height = bp_all.attr("height");

        // get a minidataset of the data's region
        let region_data = data.filter(dpoints => dpoints.region_name == d.region_name);

        // x version of the hour scale. uses same hourExtent
        let new_hourScale = d3.scaleLinear().domain(hourExtent).range([20,region_width-20]);
        
        // create the lines
        d3.select("#bubbleplot-region").append("line").attr("x1",new_hourScale(hourExtent[0])-10).attr("x2",new_hourScale(hourExtent[1])+10)
                                        .attr("y1", region_height/2).attr("y2", region_height/2).attr("class","dashed");
        d3.select("#bubbleplot-all").append("line").attr("x1",new_hourScale(hourExtent[0])-10).attr("x2",new_hourScale(hourExtent[1])+10)
                                        .attr("y1", all_height/2).attr("y2", all_height/2).attr("class","dashed");
        
        // create the title labels
        d3.select("#bubbleplot-region").append("text").text(`${d.region_name} Region`).attr("class","bubbleaxis").attr("x",0).attr("y",15);
        d3.select("#bubbleplot-all").append("text").text(`All Countries`).attr("class","bubbleaxis").attr("x",0).attr("y",15);

        // SIMULATIONS
        let regionSimulation = d3.forceSimulation()
                                  .nodes(region_data)
                                  .force("collision", d3.forceCollide()
                                                        .radius(2)
                                                        .iterations(3) )
                                  .force("xpos", d3.forceX()
                                                  .x( d => new_hourScale(d.hoursPerDayCombined) )
                                                  .strength( 0.1 ) )
                                  .force("ypos", d3.forceY()
                                                  .y(region_height/2)
                                                  .strength( 0.1 ) )
                                  .stop();

        let allSimulation = d3.forceSimulation()
                              .nodes(data)
                              .force("collision", d3.forceCollide()
                                                    .radius(4)
                                                    .iterations(3) )
                              .force("xpos", d3.forceX()
                                              .x( d => new_hourScale(d.hoursPerDayCombined) )
                                              .strength( 0.3 ) )
                              .force("ypos", d3.forceY()
                                              .y(all_height/2)
                                              .strength( 0.3 ) )
                              .stop();

        // run the simulation behind the scenes. references FA22 10/24 notes
        while (regionSimulation.alpha() > 0.01) { 
          regionSimulation.tick(); 
        }
        while (allSimulation.alpha() > 0.01) { 
          allSimulation.tick(); 
        }

        // draw circles 
        let br_layer = d3.select("#bubbleplot-region").append("g");
        br_layer.selectAll("circle").data(region_data)
              .enter().append("circle")
              .attr("r", 3) 
              .attr("cx", d => d.x) 
              .attr("cy", d => d.y) 
              .attr("fill", d => regionScale(d.region_name))
              .attr("stroke",datapoint=>(datapoint.country_name==d.country_name ? 'black' : ''))
              .attr("stroke-width", datapoint=>(datapoint.country_name==d.country_name) ? 2 : 1);

        let ba_layer = d3.select("#bubbleplot-all").append("g");
        ba_layer.selectAll("circle").data(data)
              .enter().append("circle")
              .attr("r", 3) 
              .attr("cx", d => d.x) 
              .attr("cy", d => d.y)
              .attr("fill", d => regionScale(d.region_name))
              .attr("stroke",datapoint=>(datapoint.country_name==d.country_name ? 'black' : ''))
              .attr("stroke-width", datapoint=>(datapoint.country_name==d.country_name) ? 2 : 1);
      });
    }

    function formatFilterText(filter) {
      // Returns: a string representing an activity category formatted for use in the subtitle and detail panel.
      // Parameter filter: an unformatted string representing a unique value of the "Category" column in the data.
      return filter == "Experience oriented" ? filter.toLowerCase() + " activities" : filter.toLowerCase();
    }

    requestData();
  </script>
</html>
